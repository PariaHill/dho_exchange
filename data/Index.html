<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµí™˜ íŠ¸ë¦¬ ê³„ì‚°ê¸°</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 0.95em;
    }
    
    .content {
      padding: 30px;
    }
    
    .input-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group:last-child {
      margin-bottom: 0;
    }
    
    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95em;
    }
    
    select, input[type="number"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s;
      background: white;
    }
    
    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-calculate {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }
    
    .btn-calculate:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-calculate:active {
      transform: translateY(0);
    }
    
    .btn-calculate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    .results {
      display: none;
    }
    
    .results.show {
      display: block;
    }
    
    .section-title {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }
    
    .tree-view {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .tree-node {
      padding: 8px 0;
      line-height: 1.6;
    }
    
    .tree-node.base {
      color: #28a745;
      font-weight: 600;
    }
    
    .tree-node.intermediate {
      color: #007bff;
    }
    
    .tree-node.circular {
      color: #dc3545;
      font-style: italic;
    }
    
    .indent {
      display: inline-block;
      width: 20px;
    }
    
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .summary-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .summary-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }
    
    .summary-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .summary-table tbody tr:hover {
      background: #f8f9fa;
    }
    
    .summary-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .quantity {
      font-weight: 600;
      color: #667eea;
    }
    
    .location {
      color: #666;
      font-size: 0.9em;
    }
    
    .stock-select {
      padding: 6px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 4px;
      font-size: 0.9em;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
      min-width: 120px;
    }
    
    .stock-select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .actual-quantity {
      font-weight: 600;
      font-size: 1.05em;
    }
    
    .stock-ê³¼ë‹¤ {
      color: #28a745;
    }
    
    .stock-í’ì¡± {
      color: #90c53f;
    }
    
    .stock-ì ì • {
      color: #ffc107;
    }
    
    .stock-ë¶€ì¡± {
      color: #ff9800;
    }
    
    .stock-ê³ ê°ˆ {
      color: #dc3545;
    }
    
    .location-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .season-icon {
      margin-left: 4px;
      cursor: help;
      font-size: 0.9em;
    }
    
    .city-peak {
      color: #90ee90;
      font-weight: 600;
    }
    
    .city-off {
      color: #ffb3b3;
      font-weight: 600;
    }
    
    .city-normal {
      color: #333;
    }
    
    .tooltip {
      visibility: hidden;
      position: absolute;
      z-index: 1000;
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      white-space: nowrap;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    
    .location-wrapper:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    .game-month {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #dc3545;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5em;
      }
      
      .content {
        padding: 20px;
      }
      
      .summary-table {
        font-size: 0.9em;
      }
      
      .summary-table th,
      .summary-table td {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒŠ ëŒ€í•­í•´ì‹œëŒ€ ì˜¤ë¦¬ì§„</h1>
      <p>êµí™˜ íŠ¸ë¦¬ ê³„ì‚°ê¸°<span id="gameMonthDisplay" class="game-month"></span></p>
    </div>
    
    <div class="content">
      <div class="input-section">
        <div class="input-group">
          <label for="itemSelect">ëª©í‘œ ì•„ì´í…œ ì„ íƒ</label>
          <select id="itemSelect">
            <option value="">ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”...</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="quantityInput">êµí™˜ íšŸìˆ˜</label>
          <select id="quantityInput">
            <option value="1" selected>1íšŒ</option>
            <option value="2">2íšŒ</option>
            <option value="3">3íšŒ</option>
            <option value="4">4íšŒ</option>
            <option value="5">5íšŒ</option>
            <option value="6">6íšŒ</option>
            <option value="7">7íšŒ</option>
            <option value="8">8íšŒ</option>
          </select>
        </div>
        
        <button class="btn-calculate" onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>
      </div>
      
      <div id="loadingDiv" class="loading" style="display: none;">
        ê³„ì‚° ì¤‘
      </div>
      
      <div id="errorDiv" class="error" style="display: none;"></div>
      
      <div id="resultsDiv" class="results">
        <h2 class="section-title">ğŸ“¦ í•„ìš”í•œ ê¸°ë³¸ ì¬ë£Œ</h2>
        <table class="summary-table">
          <thead>
            <tr>
              <th>ì•„ì´í…œ</th>
              <th>ì¬ë£Œ íƒ€ì…</th>
              <th>í•„ìš” ìˆ˜ëŸ‰</th>
              <th style="min-width: 140px;">
                ì¬ê³ 
                <select id="bulkStockSelect" onchange="applyBulkStock()" style="display: block; width: 100%; margin-top: 5px; padding: 4px 8px; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; font-size: 0.85em; background: rgba(255,255,255,0.9);">
                  <option value="">ì¼ê´„ ì ìš©...</option>
                  <option value="ê³¼ë‹¤">ê³¼ë‹¤</option>
                  <option value="í’ì¡±">í’ì¡± (+15%)</option>
                  <option value="ì ì •">ì ì • (+30%)</option>
                  <option value="ë¶€ì¡±">ë¶€ì¡± (+45%)</option>
                  <option value="ê³ ê°ˆ">ê³ ê°ˆ (+60%)</option>
                </select>
              </th>
              <th>ì‹¤ì œ í•„ìš”ëŸ‰</th>
              <th>íšë“ ì¥ì†Œ</th>
            </tr>
          </thead>
          <tbody id="summaryBody">
          </tbody>
        </table>
        
        <h2 class="section-title" style="margin-top: 30px;">ğŸ“‹ ì œì‘ íŠ¸ë¦¬</h2>
        <div id="treeView" class="tree-view"></div>
      </div>
    </div>
  </div>

  <script>
    let itemsData = [];
    let materialsData = {}; // ì¬ë£Œë³„ ì¬ê³  ìƒíƒœ ì €ì¥
    let seasonData = {}; // ì¬ë£Œë³„ ì‹œì¦Œ ì •ë³´ ì €ì¥
    
    // ì¼ê´„ ì¬ê³  ì ìš©
    function applyBulkStock() {
      const bulkValue = document.getElementById('bulkStockSelect').value;
      if (!bulkValue) {
        return; // ë¹ˆ ê°’ì´ë©´ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
      }
      
      // ëª¨ë“  ì¬ë£Œì— ì ìš©
      const summaryBody = document.getElementById('summaryBody');
      const rows = summaryBody.querySelectorAll('tr');
      
      rows.forEach(row => {
        const materialName = row.dataset.material;
        const stockSelect = row.querySelector('.stock-select');
        
        if (stockSelect) {
          stockSelect.value = bulkValue;
          onStockChange(materialName, bulkValue);
        }
      });
      
      // ì„ íƒ ì´ˆê¸°í™” (ë‹¤ì‹œ "ì¼ê´„ ì ìš©..." ìœ¼ë¡œ)
      document.getElementById('bulkStockSelect').value = '';
    }
    
    // ì¬ê³  ìƒíƒœë³„ ì¦ê°€ìœ¨
    const stockMultipliers = {
      'ê³¼ë‹¤': 1.0,
      'í’ì¡±': 1.15,
      'ì ì •': 1.30,
      'ë¶€ì¡±': 1.45,
      'ê³ ê°ˆ': 1.60
    };
    
    // ì‹¤ì œ í•„ìš”ëŸ‰ ê³„ì‚° (ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ ì˜¬ë¦¼)
    function calculateActualQuantity(baseQuantity, stockStatus) {
      const multiplier = stockMultipliers[stockStatus] || 1.0;
      return Math.ceil(baseQuantity * multiplier);
    }
    
    // ì¬ê³  ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸
    function onStockChange(materialName, newStatus) {
      materialsData[materialName] = newStatus;
      updateMaterialRow(materialName);
    }
    
    // ì¬ë£Œ í–‰ ì—…ë°ì´íŠ¸
    function updateMaterialRow(materialName) {
      const row = document.querySelector(`tr[data-material="${materialName}"]`);
      if (!row) return;
      
      const baseQuantity = parseInt(row.dataset.baseQuantity);
      const stockStatus = materialsData[materialName] || 'ê³¼ë‹¤';
      const actualQuantity = calculateActualQuantity(baseQuantity, stockStatus);
      
      const actualCell = row.querySelector('.actual-quantity');
      if (actualCell) {
        actualCell.textContent = actualQuantity + 'ê°œ';
        // ê¸°ì¡´ ìƒ‰ìƒ í´ë˜ìŠ¤ ì œê±°
        actualCell.className = 'actual-quantity';
        // ìƒˆ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€
        actualCell.classList.add('stock-' + stockStatus);
      }
      
      // íŠ¸ë¦¬ ë·°ë„ ì—…ë°ì´íŠ¸
      updateTreeView();
    }
    
    // íŠ¸ë¦¬ ë·° ì—…ë°ì´íŠ¸ (ì¬ê³  ìƒíƒœ ë°˜ì˜)
    function updateTreeView() {
      if (!window.currentTreeData) return;
      
      const treeView = document.getElementById('treeView');
      treeView.innerHTML = '';
      renderTree(window.currentTreeData, treeView);
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•„ì´í…œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    window.onload = function() {
      google.script.run
        .withSuccessHandler(function(items) {
          itemsData = items;
          populateItemSelect(items);
        })
        .withFailureHandler(function(error) {
          showError('ì•„ì´í…œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getFinishedItems(); // ì™„ì„±í’ˆë§Œ ê°€ì ¸ì˜¤ê¸°
    };
    
    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ì— ì•„ì´í…œ ì±„ìš°ê¸°
    function populateItemSelect(items) {
      const select = document.getElementById('itemSelect');
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name; // ì•„ì´í…œëª…ì„ valueë¡œ ì‚¬ìš©
        option.textContent = item.name; // ID ì œê±°
        select.appendChild(option);
      });
    }
    
    // ê³„ì‚° ì‹¤í–‰
    function calculate() {
      const itemName = document.getElementById('itemSelect').value;
      const quantity = parseInt(document.getElementById('quantityInput').value);
      
      if (!itemName) {
        showError('ì•„ì´í…œì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!quantity || quantity < 1 || quantity > 999) {
        showError('êµí™˜ íšŸìˆ˜ëŠ” 1~999 ì‚¬ì´ì˜ ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      // UI ìƒíƒœ ë³€ê²½
      document.getElementById('loadingDiv').style.display = 'block';
      document.getElementById('resultsDiv').classList.remove('show');
      document.getElementById('errorDiv').style.display = 'none';
      
      // ê³„ì‚° ìš”ì²­
      google.script.run
        .withSuccessHandler(function(result) {
          displayResults(result);
          document.getElementById('loadingDiv').style.display = 'none';
        })
        .withFailureHandler(function(error) {
          showError('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          document.getElementById('loadingDiv').style.display = 'none';
        })
        .calculate(itemName, quantity);
    }
    
    // ê²°ê³¼ í‘œì‹œ
    function displayResults(result) {
      // ì¬ê³  ìƒíƒœ ì´ˆê¸°í™”
      materialsData = {};
      seasonData = {};
      
      // íŠ¸ë¦¬ ë°ì´í„° ì €ì¥ (ì¬ê³  ë³€ê²½ ì‹œ ì¬ë Œë”ë§ìš©)
      window.currentTreeData = result.tree;
      
      // ìš”ì•½ í…Œì´ë¸”
      const summaryBody = document.getElementById('summaryBody');
      summaryBody.innerHTML = '';
      
      result.totalMaterials.sort((a, b) => a.name.localeCompare(b.name));
      
      // ëª¨ë“  ì¬ë£Œì˜ ì‹œì¦Œ ì •ë³´ë¥¼ ë¹„ë™ê¸°ë¡œ ë¡œë“œ
      const materialNames = result.totalMaterials.map(mat => mat.name);
      let loadedCount = 0;
      
      result.totalMaterials.forEach((mat, index) => {
        const row = document.createElement('tr');
        row.dataset.material = mat.name;
        row.dataset.baseQuantity = mat.quantity;
        
        // ê¸°ë³¸ ì¬ê³  ìƒíƒœëŠ” 'ê³¼ë‹¤'
        materialsData[mat.name] = 'ê³¼ë‹¤';
        const actualQuantity = calculateActualQuantity(mat.quantity, 'ê³¼ë‹¤');
        
        // ì¬ë£Œ íƒ€ì… í‘œì‹œ
        const materialType = mat.isBase ? 'ê¸°ë³¸ ì¬ë£Œ' : 'ì¤‘ê°„ ì¬ë£Œ';
        const materialTypeColor = mat.isBase ? '#28a745' : '#007bff';
        
        // í•„ìš” ìˆ˜ëŸ‰ í‘œì‹œ
        let quantityDisplay = `${mat.quantity}ê°œ`;
        if (!mat.isBase && mat.exchangeCount) {
          // ì¤‘ê°„ì¬ë£Œ: êµí™˜ íšŸìˆ˜ í‘œì‹œ
          quantityDisplay = `${mat.exchangeCount}íšŒ (â†’${mat.quantity}ê°œ)`;
        } else if (!mat.isBase && mat.outputQuantity) {
          // ì¤‘ê°„ì¬ë£Œ fallback: 1íšŒë‹¹ ìƒì‚°ëŸ‰ í‘œì‹œ
          quantityDisplay = `${mat.quantity}ê°œ (1íšŒâ†’${mat.outputQuantity}ê°œ)`;
        }
        
        // íšë“ ì¥ì†Œ í‘œì‹œ (Port ë˜ëŠ” Town)
        let locationDisplay = '';
        const allLocations = [];
        
        // Port location ì¶”ê°€ (ë‹¤ì–‘í•œ êµ¬ë¶„ìë¡œ split)
        if (mat.location) {
          // ì „ê°/ë°˜ê° ì‰¼í‘œ, ìŠ¬ë˜ì‹œ, ì„¸ë¯¸ì½œë¡  ë“±ìœ¼ë¡œ êµ¬ë¶„
          const portLocations = mat.location
            .split(/[,ï¼Œ\/;ã€]/)  // ì˜ë¬¸ì‰¼í‘œ, í•œê¸€ì‰¼í‘œ, ìŠ¬ë˜ì‹œ, ì„¸ë¯¸ì½œë¡ , ì¼ë³¸ì‰¼í‘œ
            .map(loc => loc.trim())
            .filter(loc => loc);
          allLocations.push(...portLocations);
        }
        
        // Town ë§ˆì„ ì¶”ê°€
        if (mat.towns && mat.towns.length > 0) {
          allLocations.push(...mat.towns);
        }
        
        // ì¤‘ë³µ ì œê±° í›„ í‘œì‹œ
        const uniqueLocations = [...new Set(allLocations)];
        locationDisplay = uniqueLocations.length > 0 ? uniqueLocations.join(', ') : '-';
        
        row.innerHTML = `
          <td>${mat.name}</td>
          <td style="color: ${materialTypeColor}; font-weight: 600;">${materialType}</td>
          <td class="quantity">${quantityDisplay}</td>
          <td>
            <select class="stock-select" onchange="onStockChange('${mat.name}', this.value)">
              <option value="ê³¼ë‹¤" selected>ê³¼ë‹¤</option>
              <option value="í’ì¡±">í’ì¡± (+15%)</option>
              <option value="ì ì •">ì ì • (+30%)</option>
              <option value="ë¶€ì¡±">ë¶€ì¡± (+45%)</option>
              <option value="ê³ ê°ˆ">ê³ ê°ˆ (+60%)</option>
            </select>
          </td>
          <td class="actual-quantity stock-ê³¼ë‹¤">${actualQuantity}ê°œ</td>
          <td class="location" id="location-${index}">
            <span class="location-text">${locationDisplay}</span>
            <span class="season-loading" style="color: #999; font-size: 0.85em;"> (ë¡œë”©ì¤‘...)</span>
          </td>
        `;
        summaryBody.appendChild(row);
        
        // ì‹œì¦Œ ì •ë³´ ë¹„ë™ê¸° ë¡œë“œ (ê¸°ë³¸ ì¬ë£Œë§Œ)
        if (mat.isBase) {
          google.script.run
            .withSuccessHandler(function(seasonInfo) {
              seasonData[mat.name] = seasonInfo;
              updateLocationCell(index, mat.name, locationDisplay, seasonInfo);
              
              loadedCount++;
              if (loadedCount === materialNames.filter(n => result.totalMaterials.find(m => m.name === n).isBase).length) {
                console.log('ëª¨ë“  ì‹œì¦Œ ì •ë³´ ë¡œë“œ ì™„ë£Œ');
              }
            })
            .withFailureHandler(function(error) {
              console.error('ì‹œì¦Œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', mat.name, error);
              const locationCell = document.getElementById('location-' + index);
              if (locationCell) {
                const loadingSpan = locationCell.querySelector('.season-loading');
                if (loadingSpan) loadingSpan.remove();
              }
            })
            .getMaterialSeasonInfo(mat.name);
        } else {
          // ì¤‘ê°„ ì¬ë£ŒëŠ” ì‹œì¦Œ ì •ë³´ ì—†ì´ Townë§Œ í‘œì‹œ
          const locationCell = document.getElementById('location-' + index);
          if (locationCell) {
            const loadingSpan = locationCell.querySelector('.season-loading');
            if (loadingSpan) loadingSpan.remove();
          }
        }
      });
      
      // íŠ¸ë¦¬ ë·°
      const treeView = document.getElementById('treeView');
      treeView.innerHTML = '';
      renderTree(result.tree, treeView);
      
      // ê²°ê³¼ í‘œì‹œ
      document.getElementById('resultsDiv').classList.add('show');
    }
    
    // íšë“ ì¥ì†Œ ì…€ ì—…ë°ì´íŠ¸ (ì‹œì¦Œ ì •ë³´ í¬í•¨)
    function updateLocationCell(index, materialName, baseLocation, seasonInfo) {
      const locationCell = document.getElementById('location-' + index);
      if (!locationCell) return;
      
      // ë¡œë”© í‘œì‹œ ì œê±°
      const loadingSpan = locationCell.querySelector('.season-loading');
      if (loadingSpan) loadingSpan.remove();
      
      if (!seasonInfo || !seasonInfo.cities || seasonInfo.cities.length === 0) {
        return;
      }
      
      // í˜„ì¬ ê²Œì„ ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
      if (seasonInfo.currentMonth) {
        const gameMonthDisplay = document.getElementById('gameMonthDisplay');
        if (gameMonthDisplay && !gameMonthDisplay.textContent) {
          gameMonthDisplay.textContent = `ê²Œì„ ë‚´ ${seasonInfo.currentMonth}ì›”`;
        }
      }
      
      let html = '<div class="location-wrapper">';
      
      // ê° ë„ì‹œë³„ë¡œ í‘œì‹œ
      seasonInfo.cities.forEach((city, idx) => {
        if (idx > 0) html += ', ';
        
        // ì‹œì¦Œë³„ ìƒ‰ìƒ í´ë˜ìŠ¤ ì ìš©
        let cityClass = 'city-normal';
        let iconClass = 'season-icon season-normal';
        let icon = 'ğŸ…';
        
        if (city.season === 'ì„±ìˆ˜ê¸°') {
          cityClass = 'city-peak';
          iconClass = 'season-icon';
          icon = 'â–²';
        } else if (city.season === 'ë¹„ìˆ˜ê¸°') {
          cityClass = 'city-off';
          iconClass = 'season-icon';
          icon = 'â–¼';
        }
        
        html += `<span class="city-with-season ${cityClass}">`;
        html += city.name;
        html += `<span class="${iconClass}">${icon}</span>`;
        html += `</span>`;
      });
      
      // íˆ´íŒ ì¶”ê°€
      html += '<div class="tooltip">';
      seasonInfo.cities.forEach((city, idx) => {
        if (idx > 0) html += '<br>';
        html += `<strong>${city.name}</strong>`;
        if (city.country) html += ` | ${city.country}`;
        if (city.region) html += ` | ${city.region}`;
        if (city.epidemic) html += ` | ëŒ€ìœ í–‰: ${city.epidemic}`;
        if (city.climate) html += ` | ê¸°í›„: ${city.climate}`;
      });
      html += '</div>';
      
      html += '</div>';
      
      locationCell.innerHTML = html;
    }
    
    // íŠ¸ë¦¬ ë Œë”ë§ (ì¬ê·€)
    function renderTree(node, container, depth = 0) {
      const div = document.createElement('div');
      div.className = 'tree-node';
      
      if (node.isCircular) {
        div.classList.add('circular');
      } else if (node.isBase) {
        div.classList.add('base');
      } else {
        div.classList.add('intermediate');
      }
      
      // ë“¤ì—¬ì“°ê¸°
      let indent = '';
      for (let i = 0; i < depth; i++) {
        indent += '<span class="indent">â”‚</span>';
      }
      
      if (depth > 0) {
        indent += '<span class="indent">â”œâ”€</span>';
      }
      
      const icon = node.isBase ? 'ğŸ”¹' : (node.isCircular ? 'âš ï¸' : 'ğŸ“¦');
      const warning = node.isCircular ? ' [ìˆœí™˜ ì°¸ì¡°!]' : '';
      
      // êµí™˜ íšŸìˆ˜ì™€ ê²°ê³¼ë¬¼ ìˆ˜ëŸ‰ í‘œì‹œ
      let displayText = '';
      if (node.isBase) {
        // ê¸°ë³¸ ì¬ë£ŒëŠ” ì¬ê³  ìƒíƒœ ë°˜ì˜
        const stockStatus = materialsData[node.name] || 'ê³¼ë‹¤';
        const actualQuantity = calculateActualQuantity(node.exchangeCount, stockStatus);
        
        // ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
        const colorClass = 'stock-' + stockStatus;
        
        if (stockStatus === 'ê³¼ë‹¤') {
          displayText = `${node.name} <span class="${colorClass}">x${node.exchangeCount}</span>`;
        } else {
          displayText = `${node.name} x${node.exchangeCount} â†’ <span class="${colorClass}" style="font-weight: 600;">x${actualQuantity}</span> (${stockStatus})`;
        }
      } else {
        // ì™„ì„±í’ˆ/ì¤‘ê°„ì¬ë£ŒëŠ” êµí™˜ íšŸìˆ˜ì™€ ê²°ê³¼ë¬¼ í‘œì‹œ
        displayText = `${node.name} (${node.exchangeCount}íšŒ êµí™˜ â†’ ${node.outputQuantity}ê°œ íšë“)`;
      }
      
      div.innerHTML = `${indent}${icon} ${displayText}${warning}`;
      container.appendChild(div);
      
      // ìì‹ ë…¸ë“œ ì¬ê·€ ë Œë”ë§
      if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
          renderTree(child, container, depth + 1);
        });
      }
    }
    
    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      const errorDiv = document.getElementById('errorDiv');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
